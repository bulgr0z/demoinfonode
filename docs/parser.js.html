<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: parser.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: parser.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var Structs = require('./structs.js')
	, MessageDecoder = require('./messagedecoder.js')
	, Q = require('q');

/**
 * Parses and extracts packets from the demofile.
 * The parser will decode basic structs (eg. header) and delegate the packets containing
 * protobuf messages to MessageDecoder 
 *
 * @constructor
 * @param {Buffer} demoBuffer - raw demoBuffer
 * @param {Stream} outputStream - stream to output parsed packets on
 */
var Parser = function(demoBuffer, outputStream) {
	
	this.demoBuffer = demoBuffer;
	this.outputStream = outputStream;

	this.messageDecoder = new MessageDecoder(this.demoBuffer);

	this.readHeader();

	this.packetCount = {
		1 : 0,
		2 : 0,
		3 : 0,
		4 : 0,
		5 : 0,
		6 : 0,
		7 : 0,
		8 : 0,
		9 : 0
	};

	this.loop(this.readNextPacket.bind(this)).then(function() {
		console.log('WTF DONE ?')
	}).catch(function(e) {
		console.log('BAD STUFF ', e)
	});
	// start parser loop
	//this.readNextFrame();

	// bad bloquant ? des events ca serait plus cool
	// while (!this.demoEnded) {
	// 	this.readNextFrame();
	// }

};

Parser.prototype = {
	
	demoBuffer : null,
	outputStream : null,
	demoEnded : false,
	isValidDemo : false,

	commands : {
		1 : 'signon',
		2 : 'packet',
		3 : 'syntick',
		4 : 'consolecmd',
		5 : 'usercmd',
		6 : 'datatables',
		7 : 'stop',
		8 : 'customdata',
		9 : 'stringtables'
	},
	
	readHeader : function() {
		var header = Structs.Header.decode(this.demoBuffer);
		if (header.demoType === 'HL2DEMO') this.isValidDemo = true;

		this.output(header, "DEMO HEADER");
	},

	/**
	 * Reads each `frame` of the demo (each frame containing 0 or more protobuf messages)
	 *
	 */
	readNextPacket : function() {
		var packetMetadata = Structs.PacketMetadata.decode(this.demoBuffer);

		console.log('+++ READING NEW FRAME. HEADER COMMAND : ', packetMetadata)
		
		// var promiseNextFrame = Q.promise(function() {
		// 	this.output(messages, '-- PACKET --'); // write to buffer
		// 	this.readNextFrame(); // get back to the loop
		// }.bind(this));
		
		// if (this.commands[header.cmd] == 5) {
		// 	console.log('5555555555')
		// 	process.exit(code=0);

		// }

		this.packetCount[packetMetadata.cmd] += 1;

		switch (this.commands[packetMetadata.cmd]) {
			case 'packet' :
			case 'signon' :

				// this.messageDecoder.decodeNetPacket(this._decodedFrameCallback.bind(this))
				return this.messageDecoder.decodeNetPacket()

				// var message = this.messageDecoder.decodeNetPacket(function(messages) {
				// 	// console.log('JOB DONE ?')
				// 	// console.log(msg)
				// 	this.output(messages);
				// 	this.readNextFrame(); // get back to the loop
				// }.bind(this));

				// console.log(this.demoBuffer)
				// var cmdinfo = Structs.CmdInfo.decode(this.demoBuffer);
				// console.log(cmdinfo)
				// console.log(this.demoBuffer)
				break; 

			case 'usercmd' : 

			// ECstrike15UserMessages: 
			//   { CS_UM_VGUIMenu: 1,
			//     CS_UM_Geiger: 2,
			//     CS_UM_Train: 3,
			//     CS_UM_HudText: 4,
			//     CS_UM_SayText: 5,

				console.log('USER CMD !')
				break;

			case 'stop' : 
				console.log('DEMO END ! this silly parser made it.')
				break;

			case 'stringtables' :
			case 'datatables' :
			case 'consolecmd' :

				return this.messageDecoder.decodeRawPacket();
				//this.messageDecoder.decodeRawPacket(this._decodedFrameCallback.bind(this));
				break;

			case 'syntick' :
				// this.output(header, 'SYNTICK');
				// this.readNextFrame(); // continue
				var dummy = Q.defer();
				dummy.resolve([]); // dummy, was breaking the loop
				return dummy.promise;
				break;
		}


		console.log("packet count : ", this.packetCount)
		console.log('CMD : ', packetMetadata);
	},

	loop : function(cb) {
		console.log('THEN	 !', cb)
		return cb().then(function(decodedPacket) {
			this.output(decodedPacket, 'PACKET ?')
			return this.loop(cb);
		}.bind(this));
	},

	// called on the last frame / error
	demoEnd : function() {
		this.outputStream.end();
	},
  
  // outputs messages
	output : function(message, title)Â {
		this._outputString(message, title)
	},

	/**
	 * Generic callback used by readNextPacket when messages are decoded
	 * Writes the received messages on the buffer and reads the next frame.
	 */
	_decodedFrameCallback : function(messages) {
		this.output(messages, '-- PACKET --'); // write to buffer
		this.readNextPacket(); // get back to the loop
	},

	_outputString : function(message, title) {				
		var header = '';
		if (typeof title === 'string') header = "----- " + title + "\n";
		console.log('write')
		this.outputStream.write(header + JSON.stringify(message, null, 4) + "\n\n");
	}

};

module.exports = Parser;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="MessageDecoder.html">MessageDecoder</a></li><li><a href="Parser.html">Parser</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a> on Thu Nov 06 2014 16:16:07 GMT+0100 (CET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
